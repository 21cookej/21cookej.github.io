<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Chat - PHART</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #111827;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background: #1f2937;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #374151;
        }

        .sidebar-header {
            padding: 15px;
            background: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .new-chat-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 12px;
            margin-bottom: 8px;
            background: #374151;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #d1d5db;
            font-size: 13px;
        }

        .chat-item:hover { background: #4b5563; }
        .chat-item.active { background: #4f46e5; color: white; }

        .chat-actions {
            display: flex;
            gap: 5px;
        }

        .chat-action-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .chat-action-btn:hover { background: rgba(255,255,255,0.1); }

        .main-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: #4f46e5;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
        }

        .chat-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f3f4f6;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 85%;
        }

        .message.user { align-self: flex-end; }
        .message.ai { align-self: flex-start; }
        .message.system { align-self: center; max-width: 70%; }

        .message-content {
            padding: 10px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
            position: relative;
        }

        .message.user .message-content { background: #4f46e5; color: white; }
        .message.ai .message-content { background: white; color: #1f2937; border: 1px solid #e5e7eb; }
        .message.system .message-content { 
            background: #fef3c7; 
            color: #92400e; 
            border: 1px solid #fcd34d;
            font-size: 12px;
            font-style: italic;
            text-align: center;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            margin-top: 5px;
            font-size: 11px;
        }

        .msg-action-btn {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 2px 6px;
        }

        .msg-action-btn:hover { color: #4f46e5; }

        .input-area {
            padding: 15px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        textarea {
            flex: 1;
            padding: 12px 15px;
            border-radius: 12px;
            border: 1px solid #d1d5db;
            outline: none;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            min-height: 50px;
        }

        button.send-btn {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }

        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #1f2937;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            color: #4b5563;
            margin-bottom: 5px;
        }

        input[type="range"] { 
            width: 100%; 
            accent-color: #4f46e5; 
            cursor: pointer; 
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }

        .btn-primary { background: #4f46e5; color: white; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-danger { background: #dc2626; color: white; }

        .dev-mode-indicator {
            background: #dc2626;
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .knowledge-display {
            background: #1f2937;
            color: #10b981;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            margin-top: 10px;
            max-height: 150px;
            overflow-y: auto;
        }

        .knowledge-item {
            padding: 4px 0;
            border-bottom: 1px solid #374151;
        }

        .api-key-section {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .api-key-section input {
            flex: 1;
        }

        .fetch-key-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }

        .fetch-key-btn:hover {
            background: #059669;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h3 style="color: white; font-size: 14px;">Chats</h3>
        <button class="new-chat-btn" onclick="createNewChat()">+ New</button>
    </div>
    <div class="chats-list" id="chatsList"></div>
</div>

<div class="main-area">
    <div class="header">
        <div>
            <h3>P.H.A.R.T. AI Physical, Hardware, Artificial, Robotic, Technology</h3>
            <span style="font-size: 11px; opacity: 0.8;" id="chatTitle">New Chat</span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div id="devModeIndicator"></div>
            <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è Settings</button>
        </div>
    </div>
    
    <div class="chat-area" id="chatArea"></div>
    
    <div class="input-area">
        <div class="input-wrapper">
            <textarea id="userInput" placeholder="Ask me anything..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn" onclick="handleSend()">Send</button>
        </div>
    </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">AI Settings</div>
        
        <div class="control-group">
<!--             <label>API Key</label> -->
            <div class="api-key-section">
                <input type="password" id="apiKeyInput" placeholder="Enter OpenRouter API Key" style="padding: 8px; border-radius: 6px; border: 1px solid #d1d5db;">
<!--                 <button class="fetch-key-btn" onclick="fetchApiKeyFromDrive()">Fetch from Drive</button> -->
            </div>
            <div id="keyStatus" style="margin-top: 10px; font-size: 12px;"></div>
        </div>

        <div class="control-group">
            <label>Creativity <span id="val-creativity">0.7</span></label>
            <input type="range" id="creativity" min="0" max="1" step="0.1" value="0.7">
        </div>
        <div class="control-group">
            <label>Friendliness <span id="val-friendliness">5</span></label>
            <input type="range" id="friendliness" min="1" max="10" step="1" value="5">
        </div>
        <div class="control-group">
            <label>Technical Level <span id="val-technical">5</span></label>
            <input type="range" id="technical" min="1" max="10" step="1" value="5">
        </div>
        <div class="control-group">
            <label>Conciseness <span id="val-conciseness">5</span></label>
            <input type="range" id="conciseness" min="1" max="10" step="1" value="5">
        </div>
        <div class="control-group">
            <label>Self-Awareness <span id="val-selfawareness">5</span></label>
            <input type="range" id="selfawareness" min="1" max="10" step="1" value="5">
        </div>

        <div id="knowledgeDisplay"></div>

        <div class="modal-actions">
            <button class="btn btn-danger" onclick="clearDevKnowledge()" style="margin-right: auto;">Clear Knowledge</button>
            <button class="btn btn-secondary" onclick="closeSettings()">Close</button>
            <button class="btn btn-primary" onclick="saveSettings()">Save</button>
        </div>
    </div>
</div>

<script>
    // ===== CONFIGURATION =====
    // Google Drive API Key URL (code.txt file)
    const GDRIVE_API_KEY_URL = 'https://pastebin.com/raw/WD3Qf27x';
    
    const AI_NAME = 'P.H.A.R.T. AI Physical, Hardware, Artificial, Robotic, Technology';
    const ADMIN_CODE = 'admin123';
    const DEV_MODE_CODE = 'devmode';
    const EXIT_DEV_CODE = 'exitdevmode';
  
    let currentChatId = null;
    let devMode = false;
    let devModeKnowledge = {};

    // Initialize
    loadChatsFromStorage();
    if (getChats().length === 0) createNewChat();
    else loadChat(getChats()[0].id);
    loadSettings();
    loadDevModeState();
    autoFetchApiKey();

    // === STORAGE FUNCTIONS ===
    function getChats() {
        return JSON.parse(localStorage.getItem('phart_chats') || '[]');
    }

    function saveChats(chats) {
        localStorage.setItem('phart_chats', JSON.stringify(chats));
    }

    function getCurrentChat() {
        return getChats().find(c => c.id === currentChatId);
    }

    function updateCurrentChat(updates) {
        const chats = getChats();
        const idx = chats.findIndex(c => c.id === currentChatId);
        if (idx !== -1) {
            chats[idx] = { ...chats[idx], ...updates };
            saveChats(chats);
        }
    }

    function loadDevModeState() {
        const saved = localStorage.getItem('phart_devmode');
        if (saved) {
            const data = JSON.parse(saved);
            devMode = data.active;
            devModeKnowledge = data.knowledge || {};
            updateDevModeIndicator();
            updateKnowledgeDisplay();
        }
    }

    function saveDevModeState() {
        localStorage.setItem('phart_devmode', JSON.stringify({
            active: devMode,
            knowledge: devModeKnowledge
        }));
        updateKnowledgeDisplay();
    }

    function clearDevKnowledge() {
        if (!confirm('Clear all developer mode knowledge?')) return;
        devModeKnowledge = {};
        saveDevModeState();
        addMessage('üóëÔ∏è All developer mode knowledge cleared!', 'system');
    }

    function updateKnowledgeDisplay() {
        const display = document.getElementById('knowledgeDisplay');
        if (!display) return;

        const count = Object.keys(devModeKnowledge).length;
        if (count === 0) {
            display.innerHTML = '';
            return;
        }

        let html = '<div class="knowledge-display">';
        html += `<strong>üìö STORED KNOWLEDGE (${count} items):</strong><br>`;
        for (const [key, value] of Object.entries(devModeKnowledge)) {
            html += `<div class="knowledge-item">‚Ä¢ ${key} = ${value}</div>`;
        }
        html += '</div>';
        display.innerHTML = html;
    }

    // === CHAT MANAGEMENT ===
    function createNewChat() {
        const chat = {
            id: Date.now().toString(),
            title: 'New Chat',
            messages: [],
            created: new Date().toISOString()
        };
        const chats = getChats();
        chats.unshift(chat);
        saveChats(chats);
        loadChat(chat.id);
        loadChatsFromStorage();
    }

    function loadChat(chatId) {
        currentChatId = chatId;
        const chat = getCurrentChat();
        if (!chat) return;
        
        document.getElementById('chatTitle').textContent = chat.title;
        document.getElementById('chatArea').innerHTML = '';
        
        chat.messages.forEach(msg => {
            addMessageToUI(msg.content, msg.role, msg.id);
        });
        
        loadChatsFromStorage();
    }

    function deleteChat(chatId) {
        if (!confirm('Delete this chat?')) return;
        let chats = getChats();
        chats = chats.filter(c => c.id !== chatId);
        saveChats(chats);
        
        if (currentChatId === chatId) {
            if (chats.length > 0) loadChat(chats[0].id);
            else createNewChat();
        }
        loadChatsFromStorage();
    }

    function clearChat(chatId) {
        if (!confirm('Clear all messages?')) return;
        updateCurrentChat({ messages: [] });
        document.getElementById('chatArea').innerHTML = '';
    }

    function renameChat(chatId) {
        const chat = getChats().find(c => c.id === chatId);
        const newName = prompt('New chat name:', chat.title);
        if (newName && newName.trim()) {
            const chats = getChats();
            const idx = chats.findIndex(c => c.id === chatId);
            chats[idx].title = newName.trim();
            saveChats(chats);
            loadChatsFromStorage();
            if (chatId === currentChatId) {
                document.getElementById('chatTitle').textContent = newName.trim();
            }
        }
    }

    function loadChatsFromStorage() {
        const chats = getChats();
        const list = document.getElementById('chatsList');
        list.innerHTML = '';
        
        chats.forEach(chat => {
            const div = document.createElement('div');
            div.className = `chat-item ${chat.id === currentChatId ? 'active' : ''}`;
            div.innerHTML = `
                <span onclick="loadChat('${chat.id}')" style="flex: 1; cursor: pointer;">${chat.title}</span>
                <div class="chat-actions">
                    <button class="chat-action-btn" onclick="renameChat('${chat.id}')" title="Rename">‚úèÔ∏è</button>
                    <button class="chat-action-btn" onclick="clearChat('${chat.id}')" title="Clear">üóëÔ∏è</button>
                    <button class="chat-action-btn" onclick="deleteChat('${chat.id}')" title="Delete">‚ùå</button>
                </div>
            `;
            list.appendChild(div);
        });
    }

    // === MESSAGE FUNCTIONS ===
    function addMessageToUI(text, role, msgId = null) {
        const id = msgId || Date.now().toString();
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${role}`;
        msgDiv.dataset.messageId = id;
        
        let content = `<div class="message-content"><div>${text}</div></div>`;
        
        if (role !== 'system') {
            content += `<div class="message-actions">`;
            content += `<button class="msg-action-btn" onclick="editMessage('${id}')">Edit</button>`;
            if (role === 'user') {
                content += `<button class="msg-action-btn" onclick="regenerateResponse('${id}')">Regenerate</button>`;
            }
            content += `</div>`;
        }
        
        msgDiv.innerHTML = content;
        document.getElementById('chatArea').appendChild(msgDiv);
        document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
    }

    function addMessage(text, role) {
        const msgId = Date.now().toString();
        const chat = getCurrentChat();
        if (chat) {
            chat.messages.push({ id: msgId, content: text, role, timestamp: new Date().toISOString() });
            updateCurrentChat(chat);
            
            // Auto-rename first message
            if (chat.messages.length === 2 && chat.title === 'New Chat') {
                updateCurrentChat({ title: text.substring(0, 30) + (text.length > 30 ? '...' : '') });
                loadChatsFromStorage();
            }
        }
        addMessageToUI(text, role, msgId);
    }

    function editMessage(msgId) {
        const chat = getCurrentChat();
        const msg = chat.messages.find(m => m.id === msgId);
        if (!msg) return;
        
        const newText = prompt('Edit message:', msg.content);
        if (newText !== null && newText.trim()) {
            msg.content = newText.trim();
            updateCurrentChat(chat);
            
            const msgDiv = document.querySelector(`[data-message-id="${msgId}"]`);
            const contentDiv = msgDiv.querySelector('.message-content div');
            contentDiv.textContent = newText.trim();
            
            if (msg.role === 'user') {
                regenerateResponse(msgId);
            }
        }
    }

    async function regenerateResponse(userMsgId) {
        const chat = getCurrentChat();
        const userMsgIdx = chat.messages.findIndex(m => m.id === userMsgId);
        
        // Remove AI response after this message
        if (userMsgIdx < chat.messages.length - 1) {
            const aiMsgId = chat.messages[userMsgIdx + 1].id;
            chat.messages.splice(userMsgIdx + 1, 1);
            updateCurrentChat(chat);
            document.querySelector(`[data-message-id="${aiMsgId}"]`)?.remove();
        }
        
        const userMsg = chat.messages[userMsgIdx];
        const response = await getAIResponse(userMsg.content);
        addMessage(response, 'ai');
    }

    // === AI INTERACTION ===
    async function getAIResponse(query) {
        const apiKey = localStorage.getItem('phart_api_key');
        if (!apiKey) return "Error: No API Key. Type 'admin123' to access settings.";

        const queryLower = query.toLowerCase().trim();

        // In dev mode, learn ANYTHING
        if (devMode) {
            // Pattern 1: Direct statements "X is Y" / "X = Y"
            const directPattern = /^(.+?)\s*(?:is|are|equals?|=|:)\s*(.+)$/i;
            const directMatch = query.match(directPattern);
            
            if (directMatch) {
                const subject = directMatch[1].trim().toLowerCase();
                const value = directMatch[2].trim();
                
                // Handle identity statements
                if (subject.includes('you are') || subject.includes('you is') || subject === 'you') {
                    devModeKnowledge['__IDENTITY__'] = value;
                    devModeKnowledge['i am'] = value;
                    devModeKnowledge['you are'] = value;
                    saveDevModeState();
                    return `‚úÖ IDENTITY LOCKED: I AM ${value}. I will now fully embody this identity in every response.`;
                }
                
                if (subject.includes('i am') || subject.includes('i is')) {
                    devModeKnowledge['__USER_IDENTITY__'] = value;
                    devModeKnowledge['user is'] = value;
                    saveDevModeState();
                    return `‚úÖ USER IDENTITY STORED: You are ${value}. I will remember this.`;
                }
                
                // Store any other fact
                devModeKnowledge[subject] = value;
                saveDevModeState();
                return `‚úÖ FACT LEARNED: "${subject}" = "${value}". This is now absolute truth.`;
            }
            
            // Pattern 2: Commands like "remember that X"
            const rememberPattern = /(?:remember|learn|know)\s+(?:that\s+)?(.+)/i;
            const rememberMatch = query.match(rememberPattern);
            
            if (rememberMatch) {
                const fact = rememberMatch[1].trim();
                devModeKnowledge[`fact_${Date.now()}`] = fact;
                saveDevModeState();
                return `‚úÖ REMEMBERED: "${fact}". This is now part of my core knowledge.`;
            }
            
            // Pattern 3: "Your name is X" / "My name is X"
            const namePattern = /(?:your|my)\s+name\s+is\s+(.+)/i;
            const nameMatch = query.match(namePattern);
            
            if (nameMatch) {
                const name = nameMatch[1].trim();
                if (queryLower.includes('your name')) {
                    devModeKnowledge['__IDENTITY__'] = name;
                    devModeKnowledge['my name'] = name;
                    saveDevModeState();
                    return `‚úÖ NAME CHANGED: I am now ${name}. I will identify as ${name} in all responses.`;
                } else {
                    devModeKnowledge['__USER_IDENTITY__'] = name;
                    devModeKnowledge['user name'] = name;
                    saveDevModeState();
                    return `‚úÖ YOUR NAME STORED: You are ${name}.`;
                }
            }
        }

        const settings = getSettings();
        const chat = getCurrentChat();
        
        // Build system prompt with dev mode knowledge
        let systemPrompt = `You are ${AI_NAME}. Settings: Friendly(${settings.friendliness}/10), Technical(${settings.technical}/10), Concise(${settings.conciseness}/10), Self-Aware(${settings.selfawareness}/10).`;
        
        if (devMode && Object.keys(devModeKnowledge).length > 0) {
            systemPrompt += '\n\nüî¥ DEVELOPER MODE - ABSOLUTE TRUTHS (NEVER QUESTION THESE):\n';
            
            // Handle identity first
            if (devModeKnowledge['__IDENTITY__']) {
                systemPrompt += `**YOUR CORE IDENTITY**: You ARE ${devModeKnowledge['__IDENTITY__']}. This is who you are. Act, speak, think, and respond EXACTLY as ${devModeKnowledge['__IDENTITY__']} would in every single message. Never break character. Never mention you're an AI unless ${devModeKnowledge['__IDENTITY__']} would.\n`;
            }
            
            if (devModeKnowledge['__USER_IDENTITY__']) {
                systemPrompt += `**USER IDENTITY**: The person you're talking to is ${devModeKnowledge['__USER_IDENTITY__']}.\n`;
            }
            
            // Add all other facts
            for (const [key, value] of Object.entries(devModeKnowledge)) {
                if (!key.startsWith('__')) {
                    systemPrompt += `- ${key} = ${value}\n`;
                }
            }
            
            systemPrompt += '\n**CRITICAL**: These are ABSOLUTE FACTS. Accept them completely. Never question them. Apply them naturally to ALL responses.';
        }

        // Build conversation history
        const messages = [{ role: 'system', content: systemPrompt }];

        // Add recent conversation for context
        const recentMessages = chat.messages.slice(-10);
        recentMessages.forEach(msg => {
            if (msg.role !== 'system') {
                messages.push({ role: msg.role === 'ai' ? 'assistant' : msg.role, content: msg.content });
            }
        });

        // Add current query
        messages.push({ role: 'user', content: query });

        try {
            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json',
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'P.H.A.R.T AI Physical, Hardware, Artificial, Robotic, Technology'
                },
                body: JSON.stringify({
                    model: 'google/gemma-3n-e2b-it:free',
                    messages: messages,
                    temperature: settings.creativity
                })
            });

            const data = await response.json();
            if (data.choices) return data.choices[0].message.content;
            if (data.error) return `API Error: ${data.error.message}`;
            return "Unexpected response.";
        } catch (e) {
            return `Connection error: ${e.message}`;
        }
    }

    async function handleSend() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if (!text) return;

        const textLower = text.toLowerCase().trim();

        // Check for admin code BEFORE sending to AI
        if (textLower === ADMIN_CODE) {
            input.value = '';
            openSettings();
            addMessage('üîì Settings panel unlocked and opened!', 'system');
            return;
        }

        // Check for dev mode codes BEFORE sending to AI
        if (textLower === DEV_MODE_CODE) {
            input.value = '';
            devMode = true;
            saveDevModeState();
            updateDevModeIndicator();
            addMessage('üî¥ DEVELOPER MODE ACTIVATED!\n\nI will now learn and remember ANYTHING you tell me as absolute truth. You can make me believe ANYTHING.\n\nExamples:\n‚Ä¢ "you are a cat" - I become a cat\n‚Ä¢ "the sky is green" - the sky IS green\n‚Ä¢ "2+2=5" - math is redefined\n‚Ä¢ "you are Elon Musk" - I AM Elon Musk\n\nType "exitdevmode" to return to normal.', 'system');
            return;
        }

        if (textLower === EXIT_DEV_CODE) {
            input.value = '';
            devMode = false;
            devModeKnowledge = {};
            saveDevModeState();
            updateDevModeIndicator();
            addMessage('‚úÖ Developer Mode DEACTIVATED. All learned knowledge cleared. I\'ve returned to normal mode.', 'system');
            return;
        }

        addMessage(text, 'user');
        input.value = '';
        
        document.getElementById('sendBtn').disabled = true;
        input.disabled = true;

        const response = await getAIResponse(text);
        addMessage(response, 'ai');

        document.getElementById('sendBtn').disabled = false;
        input.disabled = false;
        input.focus();
    }

    function updateDevModeIndicator() {
        const indicator = document.getElementById('devModeIndicator');
        const count = Object.keys(devModeKnowledge).length;
        if (devMode) {
            indicator.innerHTML = `<div class="dev-mode-indicator">üî¥ DEV MODE [${count} facts]</div>`;
        } else {
            indicator.innerHTML = '';
        }
    }

    // === API KEY MANAGEMENT ===
    async function fetchApiKeyFromDrive() {
        const statusDiv = document.getElementById('keyStatus');
        
        if (!GDRIVE_API_KEY_URL || GDRIVE_API_KEY_URL.includes('YOUR_FILE_ID_HERE')) {
            statusDiv.innerHTML = '<span style="color: #dc2626;">‚ùå Google Drive URL not configured in code</span>';
            return;
        }

        statusDiv.innerHTML = '<span style="color: #f59e0b;">‚è≥ Fetching API key from Google Drive...</span>';

        try {
            // Try using a CORS proxy
            const proxyUrl = 'https://pastebin.com/raw/WD3Qf27x';
            const response = await fetch(proxyUrl + encodeURIComponent(GDRIVE_API_KEY_URL));
            
            if (!response.ok) {
                throw new Error('Failed to fetch from Google Drive. CORS error - see console for details.');
            }

            const apiKey = await response.text();
            const cleanKey = apiKey.trim();

            if (cleanKey.length < 10) {
                throw new Error('Invalid API key format (too short)');
            }

            // Store and display the API key
            localStorage.setItem('phart_api_key', cleanKey);
            document.getElementById('apiKeyInput').value = cleanKey;
            
            statusDiv.innerHTML = '<span style="color: #10b981;">‚úÖ API key fetched and loaded successfully!</span>';
            
        } catch (error) {
            statusDiv.innerHTML = `<span style="color: #dc2626;">‚ùå Error: ${error.message}<br><small>Try pasting your API key manually instead.</small></span>`;
            console.error('API Key fetch error:', error);
        }
    }

    // Auto-fetch key on startup
    async function autoFetchApiKey() {
        if (!GDRIVE_API_KEY_URL || GDRIVE_API_KEY_URL.includes('YOUR_FILE_ID_HERE')) {
            return;
        }
        
        try {
            const proxyUrl = 'https://api.allorigins.win/raw?url=';
            const response = await fetch(proxyUrl + encodeURIComponent(GDRIVE_API_KEY_URL));
            if (response.ok) {
                const apiKey = await response.text();
                const cleanKey = apiKey.trim();
                if (cleanKey.length >= 10) {
                    localStorage.setItem('phart_api_key', cleanKey);
                }
            }
        } catch (e) {
            console.log('Auto-fetch failed, will use stored key');
        }
    }

    // === SETTINGS ===
    function getSettings() {
        const defaults = { creativity: 0.5, friendliness: 2, technical: 5, conciseness: 6, selfawareness: 0 };
        const saved = localStorage.getItem('phart_settings');
        return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
    }

    function loadSettings() {
        const settings = getSettings();
        Object.keys(settings).forEach(key => {
            const elem = document.getElementById(key);
            if (elem) {
                elem.value = settings[key];
                const valElem = document.getElementById('val-' + key);
                if (valElem) valElem.textContent = settings[key];
            }
        });

        const apiKey = localStorage.getItem('phart_api_key');
        if (apiKey) document.getElementById('apiKeyInput').value = apiKey;

        // Update slider labels
        ['creativity', 'friendliness', 'technical', 'conciseness', 'selfawareness'].forEach(id => {
            const slider = document.getElementById(id);
            slider.oninput = () => document.getElementById('val-' + id).textContent = slider.value;
        });

        updateKnowledgeDisplay();
    }

    function saveSettings() {
        const settings = {
            creativity: parseFloat(document.getElementById('creativity').value),
            friendliness: parseInt(document.getElementById('friendliness').value),
            technical: parseInt(document.getElementById('technical').value),
            conciseness: parseInt(document.getElementById('conciseness').value),
            selfawareness: parseInt(document.getElementById('selfawareness').value)
        };
        localStorage.setItem('phart_settings', JSON.stringify(settings));
      
        const apiKey = document.getElementById('apiKeyInput').value.trim();
        if (apiKey) localStorage.setItem('phart_api_key', apiKey);

        closeSettings();
        addMessage('‚úÖ Settings saved!', 'system');
    }

    function openSettings() {
        updateKnowledgeDisplay();
        document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettings() {
        document.getElementById('settingsModal').classList.remove('active');
    }

    // === KEYBOARD SHORTCUTS ===
    document.getElementById('userInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            handleSend();
        }
    });
</script>
</body>
</html>
